# Plan: E2E integration tests in repo root

## Цель
Нужен независимый e2e-контур в корне, который проверяет реальный путь
UI -> flow-manager -> Docker (контейнеры Потоков), включая статусы, логи,
сообщения и валидацию внутреннего графа акторов.

## Архитектура решения
- Отдельный подпроект `e2e/` в корне репозитория.
- Тесты запускаются как black-box и общаются только с UI (HTTP/WS), не импортируя
  код из `flow-manager/` или `ui/`.
- Наблюдение за состоянием контейнеров через Docker API (socket) по label/name.
- Отдельный compose-файл для e2e, чтобы не мешать основному dev-контуры.

## Структура подпроекта
- `e2e/pyproject.toml` с зависимостями (pytest, httpx/requests, websocket client,
  docker SDK, pydantic для схем).
- `e2e/tests/` для сценариев.
- `e2e/tests/fixtures/` для фикстур запуска/cleanup и клиентов.
- `e2e/tests/helpers/` для Docker-наблюдения, ожиданий, валидации графа.

## Запуск (отдельный compose-контур)
- Новый файл `e2e/compose.e2e.yml` с `name: kawaflow-e2e`.
- Минимальный набор сервисов: `postgres`, `redis`, `rabbitmq`, `flow-manager`,
  `ui-app`, `ui-listener`, `e2e`.
- Без публикации портов и без traefik, чтобы не конфликтовать с локальным dev.
- Доступ к `/var/run/docker.sock` только внутри `flow-manager` и `e2e`.
- Добавить `e2e/Taskfile.yml` с командами `up/down/test/logs` и подключить его
  в корневой `Taskfile.yml`, чтобы вызывать через `task e2e:up` и т.п. Команды
  используют `docker compose --project-directory . -f e2e/compose.e2e.yml ...`
  чтобы пути и `.env` брались как из корня.

## Контракты наблюдаемости (docker)
- Потоки должны иметь детерминированные label/name, чтобы тесты их находили.
  Минимум: `kawaflow.flow_id`, `kawaflow.flow_name`, `kawaflow.graph_hash`.
- Для изоляции тестовых объектов в общем Docker окружении добавить label
  `kawaflow.test_run_id` (uuid) и фильтровать по нему.
- Тестовый раннер использует Docker SDK для:
  - поиска контейнера Потока по label,
  - чтения статуса (`running/exited`),
  - получения логов (tail + time-bound),
  - опционально, чтения событий Docker для быстрых ожиданий.

## Валидация внутреннего графа акторов
- Внутренний граф акторов генерируется при запуске Потока из Python-кода
  (actors = nodes, events = edges). Это не UI graph JSON.
- Нужен стабильный способ получить граф из запущенного Потока:
  - через инспекцию в flow-manager (endpoint/WS), либо
  - через событие/ответ Потока с сериализованным графом.
- В тестах валидируется:
  - runtime-граф соответствует ожидаемой структуре для конкретного Потока;
  - `kawaflow.graph_hash` совпадает с ожидаемым (хеш берется из кода/снапшота);
  - граф целостен: уникальные ID, нет висячих узлов, корректные связи.

## Сценарии (минимальный набор + расширение)
- Основной: пользователь создает Поток -> деплоит -> видит работу -> останавливает.
- Создание Потока -> контейнер `running` -> runtime-граф корректен.
- Обновление Потока (код/конфиг) -> контейнер перезапущен -> graph_hash обновлен.
- Сообщение UI -> Поток -> ответ UI -> лог контейнера содержит событие.
- Поток завершает работу по команде -> контейнер `exited` и статус обновлен.
- Ошибка конфигурации -> корректная ошибка UI -> контейнер не зависает.
- Авария актора (исключение) -> корректный статус Потока -> логи фиксируют причину.
- Массовое создание N потоков -> все контейнеры живы и изолированы.
- Параллельные сообщения -> соблюдение порядка/корректные ответы.
- Перезапуск flow-manager -> повторная регистрация и корректные статусы Потоков.
- Перезапуск UI-listener -> подписки восстанавливаются.
- Удаление Потока -> контейнер удален -> граф/метаданные очищены.

## Стабильность и диагностика
- Явные таймауты и ретраи для асинхронных состояний.
- При падении теста собираются логи UI, flow-manager и контейнера Потока.
- Cleanup в финализаторах: удаление Потоков и контейнеров по label/test_run_id.

## Результат
- Полный e2e контур в корне репозитория, независимый от сервисов.
- Проверки реального состояния контейнеров и валидности графа акторов.
- Стабильные тесты с повторяемыми детерминированными ожиданиями.

## TODO
- [x] Создать `e2e/` подпроект с `pyproject.toml` и базовой структурой tests/.
- [x] Добавить `e2e/compose.e2e.yml` с изолированным именем проекта и сервисом `e2e`.
- [x] Создать `e2e/Taskfile.yml` и подключить в корне (`task e2e:*`).
- [x] Ввести единые labels для контейнеров Потоков (flow_id, flow_name, graph_hash).
- [x] Добавить `kawaflow.test_run_id` и фильтрацию по нему.
- [x] Реализовать docker-наблюдателя: поиск, статусы, логи, события.
- [x] Сделать клиент UI (HTTP + WS) и базовые фикстуры (create/update/send/recv).
- [x] Реализовать извлечение runtime-графа (flow-manager инспекция/событие).
- [x] Реализовать валидацию графа (структура + graph_hash).
- [ ] Написать расширенные сценарии (обновление, сообщения, аварии, масштаб, перезапуски).
- [x] Добавить сбор логов и cleanup по label для флак-устойчивости.
- [x] Сделать HTML-отчет читаемым (поиск, компактные логи, улучшенный шаблон).
- [x] Разрешить XSRF-TOKEN без шифрования, чтобы e2e мог получать CSRF.
- [x] Добавить заголовок X-CSRF-TOKEN в e2e UI-клиенте.
- [ ] Разобраться с OOM при сборке/запуске e2e (docker compose build/pytest в контейнере).
