version: "3.9"

x-service-defaults: &service-defaults
  restart: unless-stopped
  networks:
    - proxy
    - internal

x-ui-defaults: &ui-defaults
  <<: *service-defaults
  image: ui:dev
  build:
    context: ./ui
    target: dev
  volumes:
    - ui_storage:/var/www/html/storage
  depends_on:
    - postgres
    - redis
    - rabbitmq
    - flow-manager
  environment:
    APP_NAME: Kawaflow
    APP_ENV: production
    APP_KEY: ${APP_KEY:-}
    APP_DEBUG: "true"
    APP_URL: http://ui.kawaflow.localhost
    DB_CONNECTION: pgsql
    DB_HOST: postgres
    DB_PORT: 5432
    DB_DATABASE: ${POSTGRES_DB:-kawaflow}
    DB_USERNAME: ${POSTGRES_USER:-kawaflow}
    DB_PASSWORD: ${POSTGRES_PASSWORD:-kawaflow}
    REDIS_HOST: redis
    REDIS_PORT: 6379
    CACHE_DRIVER: redis
    SESSION_DRIVER: redis
    QUEUE_CONNECTION: redis
    RABBITMQ_URL: ${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672/}
    FLOW_MANAGER_COMMAND_QUEUE: ${FLOW_MANAGER_COMMAND_QUEUE:-flow-manager.commands}
    FLOW_MANAGER_EVENT_EXCHANGE: ${FLOW_MANAGER_EVENT_EXCHANGE:-flow-manager.events}
    FLOW_MANAGER_EVENT_QUEUE: ${FLOW_MANAGER_EVENT_QUEUE:-flow-manager.ui.events}
    FLOW_MANAGER_TIMEOUT: ${FLOW_MANAGER_TIMEOUT:-8000}

services:
  traefik:
    image: traefik:v3.1
    command:
      - --api.dashboard=true
      - --entrypoints.web.address=:80
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`traefik.kawaflow.localhost`)
      - traefik.http.routers.traefik.entrypoints=web
      - traefik.http.routers.traefik.service=api@internal

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-kawaflow}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-kawaflow}
      POSTGRES_DB: ${POSTGRES_DB:-kawaflow}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: [ "redis-server", "--save", "20", "1", "--loglevel", "warning" ]
    volumes:
      - redis_data:/data
    networks:
      - internal
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - internal
    restart: unless-stopped

  flow-manager:
    <<: *service-defaults
    image: flow-manager:dev
    build:
      context: ./flow-manager
    environment:
      PYTHONUNBUFFERED: "1"
      SOCKET_DIR: /tmp/kawaflow/sockets
      MESSAGING_BACKEND: rabbitmq
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://guest:guest@rabbitmq:5672/}
      FLOW_MANAGER_COMMAND_QUEUE: ${FLOW_MANAGER_COMMAND_QUEUE:-flow-manager.commands}
      FLOW_MANAGER_RESPONSE_QUEUE: ${FLOW_MANAGER_RESPONSE_QUEUE:-flow-manager.responses}
      FLOW_MANAGER_EVENT_EXCHANGE: ${FLOW_MANAGER_EVENT_EXCHANGE:-flow-manager.events}
    volumes:
      - flow_sockets:/tmp/kawaflow/sockets
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - rabbitmq
    labels:
      - traefik.enable=true
      - traefik.http.routers.flow-manager.rule=Host(`flow-manager.kawaflow.localhost`)
      - traefik.http.routers.flow-manager.entrypoints=web
      - traefik.http.services.flow-manager.loadbalancer.server.port=8000

  ui-app:
    <<: *ui-defaults
    command: composer run dev
    labels:
      - traefik.enable=true
      - traefik.http.routers.ui.rule=Host(`ui.kawaflow.localhost`)
      - traefik.http.routers.ui.entrypoints=web
      - traefik.http.services.ui.loadbalancer.server.port=80

  ui-listener:
    <<: *ui-defaults
    command: php artisan flow-manager:listen

  flow:
    profiles:
      - build
    image: flow:dev
    build:
      context: .
      dockerfile: flow/Dockerfile
    command: [ "sleep", "infinity" ]
    volumes:
      - flow_sockets:/tmp/kawaflow/sockets
    networks:
      - internal
    restart: unless-stopped

  kawa:
    profiles:
      - build
    image: kawa:dev
    build:
      context: ./kawa
    command: [ "sleep", "infinity" ]
    networks:
      - internal
    restart: unless-stopped

networks:
  proxy:
    driver: bridge
  internal:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  flow_sockets:
  ui_storage:
  flow_code:
