version: "3.9"

x-service-defaults: &service-defaults
  restart: unless-stopped
  networks:
    - proxy
    - internal

x-ui-defaults: &ui-defaults
  <<: *service-defaults
  image: ui:dev
  build:
    context: ./ui
    target: dev
  volumes:
    - ./ui:/var/www/html
    - /var/www/html/vendor
    - /var/www/html/node_modules
    - ui_storage:/var/www/html/storage
  depends_on:
    - postgres
    - redis
    - rabbitmq
    - flow-manager
  environment:
    APP_NAME: ${APP_NAME}
    APP_ENV: ${APP_ENV}
    APP_KEY: ${APP_KEY}
    APP_DEBUG: ${APP_DEBUG}
    APP_URL: ${APP_URL}
    DB_CONNECTION: ${DB_CONNECTION}
    DB_HOST: ${DB_HOST}
    DB_PORT: ${DB_PORT}
    DB_DATABASE: ${POSTGRES_DB}
    DB_USERNAME: ${POSTGRES_USER}
    DB_PASSWORD: ${POSTGRES_PASSWORD}
    REDIS_HOST: ${REDIS_HOST}
    REDIS_PORT: ${REDIS_PORT}
    CACHE_STORE: redis
    SESSION_DRIVER: redis
    QUEUE_CONNECTION: redis
    RABBITMQ_URL: ${RABBITMQ_URL}
    FLOW_MANAGER_COMMAND_QUEUE: ${FLOW_MANAGER_COMMAND_QUEUE}
    FLOW_MANAGER_EVENT_EXCHANGE: ${FLOW_MANAGER_EVENT_EXCHANGE}
    FLOW_MANAGER_EVENT_QUEUE: ${FLOW_MANAGER_EVENT_QUEUE}
    FLOW_MANAGER_TIMEOUT: ${FLOW_MANAGER_TIMEOUT}

services:
  traefik:
    image: traefik:v3.1
    command:
      - --api.dashboard=true
      - --entrypoints.web.address=:80
      - --entrypoints.postgres.address=:5432
      - --entrypoints.redis.address=:6379
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
    ports:
      - "80:80"
      - "8080:8080"
      - "5432:5432"
      - "6379:6379"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`traefik.kawaflow.localhost`)
      - traefik.http.routers.traefik.entrypoints=web
      - traefik.http.routers.traefik.service=api@internal

  postgres:
    image: postgres:latest
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
      - proxy
    labels:
      - traefik.enable=true
      - traefik.tcp.routers.postgres.rule=HostSNI(`*`)
      - traefik.tcp.routers.postgres.entrypoints=postgres
      - traefik.tcp.services.postgres.loadbalancer.server.port=5432
    restart: unless-stopped

  redis:
    image: redis:alpine3.22
    command: [ "redis-server", "--save", "20", "1", "--loglevel", "warning" ]
    volumes:
      - redis_data:/data
    networks:
      - internal
      - proxy
    labels:
      - traefik.enable=true
      - traefik.tcp.routers.redis.rule=HostSNI(`*`)
      - traefik.tcp.routers.redis.entrypoints=redis
      - traefik.tcp.services.redis.loadbalancer.server.port=6379
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:4.2.1-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - internal
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.kawaflow.localhost`)
      - traefik.http.routers.rabbitmq.entrypoints=web
      - traefik.http.services.rabbitmq.loadbalancer.server.port=15672
    restart: unless-stopped

  flow-manager:
    <<: *service-defaults
    image: flow-manager:dev
    build:
      context: ./flow-manager
    environment:
      PYTHONUNBUFFERED: "1"
      SOCKET_DIR: /tmp/kawaflow/sockets
      MESSAGING_BACKEND: rabbitmq
      RABBITMQ_URL: ${RABBITMQ_URL}
      FLOW_MANAGER_COMMAND_QUEUE: ${FLOW_MANAGER_COMMAND_QUEUE}
      FLOW_MANAGER_RESPONSE_QUEUE: ${FLOW_MANAGER_RESPONSE_QUEUE}
      FLOW_MANAGER_EVENT_EXCHANGE: ${FLOW_MANAGER_EVENT_EXCHANGE}
    volumes:
      - flow_sockets:/tmp/kawaflow/sockets
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - rabbitmq
    labels:
      - traefik.enable=true
      - traefik.http.routers.flow-manager.rule=Host(`flow-manager.kawaflow.localhost`)
      - traefik.http.routers.flow-manager.entrypoints=web
      - traefik.http.services.flow-manager.loadbalancer.server.port=8000

  ui-app:
    <<: *ui-defaults
    command: composer run dev
    labels:
      - traefik.enable=true
      - traefik.http.routers.ui.rule=Host(`ui.kawaflow.localhost`)
      - traefik.http.routers.ui.entrypoints=web
      - traefik.http.services.ui.loadbalancer.server.port=8000

  ui-listener:
    <<: *ui-defaults
    command: php artisan flow-manager:listen

  flow:
    profiles:
      - build
    image: flow:dev
    build:
      context: .
      dockerfile: flow/Dockerfile
    command: [ "sleep", "infinity" ]
    volumes:
      - flow_sockets:/tmp/kawaflow/sockets
    networks:
      - internal
    restart: unless-stopped

  kawa:
    profiles:
      - build
    image: kawa:dev
    build:
      context: ./kawa
    command: [ "sleep", "infinity" ]
    networks:
      - internal
    restart: unless-stopped

networks:
  proxy:
    driver: bridge
  internal:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  flow_sockets:
  ui_storage:
  flow_code:
